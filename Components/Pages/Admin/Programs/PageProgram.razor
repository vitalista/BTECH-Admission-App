@page "/programs"
@using BTECH_APP.Components.Shared
@layout Components.Layout.AdminLayout
@inject IDialogService DialogService
@inject IProgramService _Service
@using BTECH_APP.Models.Admin.Program
@using BTECH_APP.Services.Admin.Interfaces
@using Helpers

<div style="width:100%">
<div Style="padding-top:30px;display:flex;justify-content:flex-end;">
    <MudButton OnClick="OpenComponentCreate"
               StartIcon="@Icons.Material.Filled.AddCircleOutline"
               Color="Color.Success"
               Size="Size.Small"
               Variant="Variant.Filled"
               Style="margin-right:5px">
        Create
    </MudButton>
</div>

<ComponentTable TItem="ListProgramModel"
                Items="Programs"
                Title="Programs"
                EnableSearch="true"
                FilterFunc="FilterElement">

    <HeaderTemplate>
        <MudTh><MudTableSortLabel SortBy="new Func<ListProgramModel, object>(x => x.Name)">Program Name</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ListProgramModel, object>(x => x.InstituteName)">Institute</MudTableSortLabel></MudTh>
        <MudTh Style="width:30px"><MudTableSortLabel SortBy="new Func<ListProgramModel, object>(x => x.Status)">Status</MudTableSortLabel></MudTh>
        <MudTh Style="width:300px"><MudTableSortLabel SortBy="new Func<ListProgramModel, object>(x => x.ModifiedDate ?? DateTime.UtcNow)">Last Updated</MudTableSortLabel></MudTh>
        <MudTh Style="width:30px">Actions</MudTh>
    </HeaderTemplate>

    <RowTemplate Context="program">
        <MudTd DataLabel="Program Info">
            <div>
                <strong>@program.Name</strong>
            </div>
            <div>
                <small>@program.Acronym</small>
            </div>
        </MudTd>
        <MudTd DataLabel="Institute">
            <div>
                <strong>@program.InstituteName</strong>
            </div>
            <div>
                <small>@program.InstituteAcronym</small>
            </div>
        </MudTd>
        <MudTd DataLabel="Status">@program.Status</MudTd>
        <MudTd DataLabel="Last Updated">
            <div>
                <strong>@program.ModifiedByName</strong>
            </div>
            <div>
                <small>On: @Helper.FormatDate(@program.ModifiedDate)</small>
            </div>
        </MudTd>
        <MudTd DataLabel="Action">
            <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                      Dense
                      AnchorOrigin="Origin.TopRight"
                      TransformOrigin="Origin.TopRight">
                 <MudMenuItem Icon="@Icons.Material.Filled.Edit" Label="Edit" OnClick="()=>OpenComponentEdit(program.ProgramId)" />
                 <MudMenuItem Icon="@Icons.Material.Filled.Delete" Label="Delete" OnClick="()=>OpenComponentDelete(program.ProgramId)" />
             </MudMenu>
         </MudTd>
    </RowTemplate>

</ComponentTable>
</div>

 @code {
    private List<ListProgramModel> Programs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        Programs = await _Service.List();
        StateHasChanged();
    }

    private bool FilterElement(ListProgramModel program, string search)
    {
        return program.Name.Contains(search, StringComparison.OrdinalIgnoreCase)
            || program.Acronym.Contains(search, StringComparison.OrdinalIgnoreCase)
            || program.Status.Contains(search, StringComparison.OrdinalIgnoreCase)
            || program.InstituteName.Contains(search, StringComparison.OrdinalIgnoreCase)
            || program.InstituteAcronym.Contains(search, StringComparison.OrdinalIgnoreCase);
    }

    private async Task OpenComponentCreate()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true };

        var dialog = await DialogService.ShowAsync<ComponentCreate>("Create Program", options);
        var result = await dialog.Result;

        if (result != null)
            if (!result.Canceled)
            {
                await LoadData();
            }
    }

    private async Task OpenComponentEdit(int programId)
    {
        var program = await _Service.Find(programId);

        if (program != null)
        {
            var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true };

            var prop = new DialogParameters
            {
                {nameof(ComponentEdit.model), program}
            };

            var dialog = await DialogService.ShowAsync<ComponentEdit>("Update Program", prop, options);
            var result = await dialog.Result;

            if (result != null)
                if (!result.Canceled)
                {
                    await LoadData();
                }
        }
    }

    private async Task OpenComponentDelete(int instituteId)
    {
        var institute = await _Service.Find(instituteId);

        if (institute != null)
        {
            var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true };

            var prop = new DialogParameters
            {
                {nameof(ComponentDelete.model), institute}
            };

            var dialog = await DialogService.ShowAsync<ComponentDelete>("Delete Program", prop, options);
            var result = await dialog.Result;

            if (result != null)
                if (!result.Canceled)
                {
                    await LoadData();
                }
        }
    }
    
}
